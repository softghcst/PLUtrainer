<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>H-Mart PLU Trainer</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<meta name="theme-color" content="#E6002D">
<meta name="apple-mobile-web-app-title" content="H-Mart PLU Trainer">
<style>
  /* === Theme variables === */
:root {
  --bg: #0b0f19;        /* page background (dark) */
  --fg: #e9eef9;        /* default text (dark) */
  --card: #0f1422;      /* card surfaces (dark) */
  --muted: #9fb0d1;     /* secondary text (dark) */
  --accent: #E6002D;    /* H-Mart red */

  /* shared surfaces */
  --surface: #111927;   /* buttons, chips, inputs (dark) */
  --border: #22304a;    /* borders (dark) */
}

/* Light theme overrides (applied to <body class="light">) */
body.light {
  --bg: #f6f8fc;
  --fg: #0b0f19;
  --card: #ffffff;
  --muted: #6b7a93;

  --surface: #f4f6fb;
  --border: #e1e6f0;
}

/* Apply variables globally */
body {
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}

.card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 10px; }

header {
  position: sticky; top: 0; z-index: 9;
  display: flex; gap: 8px; align-items: center;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}

h1{font-size:1.1rem;margin:0}
.muted{color:var(--muted)}
.small{font-size:.9rem}

main{display:grid;grid-template-columns:1fr;gap:10px;padding:10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* Buttons / chips / inputs now use theme vars */
.btn{
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--fg);
  border-radius: 10px;
  padding: 8px 10px;
  cursor: pointer;
}
.btn[disabled] { 
  opacity:.6; 
  cursor:not-allowed; 
}

.pill, .chip{
  display:inline-flex; gap:6px; align-items:center;
  border:1px solid var(--border);
  background: var(--surface);
  padding:6px 10px; border-radius:999px; font-size:.8rem; color: var(--fg);
}

input,select{
  background: var(--card);
  border:1px solid var(--border);
  color: var(--fg);
  border-radius:8px; padding:8px;
}

code,.code{
  font-family: ui-monospace, Menlo, Consolas, monospace;
  background: var(--bg);
  border:1px solid var(--border);
  border-radius:6px; padding:2px 6px;
}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px 8px;text-align:left}

.imgbox{
  width:120px;height:120px;
  background: var(--surface);
  border:1px solid var(--border);
  border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.imgbox img{max-width:100%;max-height:100%;display:block}

/* Bottom tabs */
.tabs{
  position:sticky; bottom:0; left:0; right:0;
  background: var(--card);
  border-top:1px solid var(--border);
  display:flex; gap:6px; padding:6px; justify-content:space-around; z-index:10;
}
.tabbtn{
  flex:1; text-align:center; padding:8px; border-radius:8px;
  border:1px solid var(--border);
  background: var(--surface);
  color: var(--fg);
  font-size:.8rem;
}
.tabbtn.active{ background: var(--accent); border-color:#b00020; color:#fff }

.panel{ display:none }
.panel.active{ display:block }
  
/* Lists */
.list{max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px}
.list .rowline{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}

/* SRS Badge colors */
#srsBadge { padding: 1px 6px; border-radius: 6px; }
#srsBadge.ON { background:#0f3120; color:#3bd17f; font-weight:700; }
#srsBadge.OFF{ background:#2a2f3a; color:#9fb0d1; }
/* Light badge variants */
.light #srsBadge.ON{ background:#e8f7ee; color:#147a3a; }
.light #srsBadge.OFF{ background:#eef1f6; color:#6b7a93; }

.star{cursor:pointer;font-size:1.1rem}
.bigpad{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.bigkey{
  padding:20px;
  border-radius:14px;
  text-align:center;
  background: var(--surface);
  border:1px solid var(--border);
  font-size:1.6rem;
  font-weight:900;
}
.bigkey.big{grid-column:span 3}

/* Checkout visuals */
.checkout-area{
  display:flex; align-items:center; gap:12px;
  padding:10px; border:1px solid var(--border); border-radius:12px;
  background: var(--card);
}
.checkout-area{ position: relative; }
.checkout-area::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.03));
  border-radius:12px;
}
  /* === Checkout patches === */
/* Start/Stop colors that work in light + dark */
.btn.green{ background:#0f3120; border-color:#1e7448; color:#e9f7ef; }
.light .btn.green{ background:#25a86b; border-color:#158a54; color:#fff; }

.btn.red{ background:#b00020; border-color:#8a0019; color:#fff; }
.light .btn.red{ background:#E6002D; border-color:#b00020; color:#fff; }

/* Belt animation should NOT move until the game starts */
.belt::before{ animation-play-state: paused; }
.belt.running::before{ animation-play-state: running; }
/* Avatar (supports .avatar) */
.avatar, .customerAvatar{
  width:72px; height:72px; min-width:72px; /* ✅ prevents flex shrink */
  border-radius:12px; overflow:hidden;
  border:1px solid var(--border); background: var(--card);
  display:flex; align-items:center; justify-content:center;
}
.avatar img, .customerAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
/* Belt items should not animate or show until the game is running */
.belt .belt-item{ 
  animation-play-state: paused; 
  opacity: 0;
}
.belt.running .belt-item{
  animation-play-state: running;
  opacity: 1;
}
/* Belt */
.belt{
  position:relative; flex:1; height:80px; border-radius:10px; overflow:hidden;
  border:1px solid var(--border); background: var(--card);
}
.belt::before{
  content:""; position:absolute; inset:0;
  background: repeating-linear-gradient(-45deg, rgba(255,255,255,.04) 0 12px, rgba(255,255,255,.02) 12px 24px);
  animation: beltMove 2.8s linear infinite; pointer-events:none;
}
@keyframes beltMove{ 0%{ transform: translateX(0) } 100%{ transform: translateX(-48px) } }

#beltItems{ position:absolute; inset:0; }

.belt-item{
  position:absolute; bottom:10px; width:58px; height:58px;
  display:flex; align-items:center; justify-content:center;
  background: var(--surface); border:1px solid var(--border); border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.25); font-size:30px; user-select:none;
  animation: slideAcross 9s linear infinite;
}
.belt-item .hint{
  position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  font-size:.70rem; color:var(--muted);
  background: rgba(0,0,0,.35); padding:2px 6px; border-radius:6px; border:1px solid var(--border);
}
@keyframes slideAcross{
  0%{ transform:translateX(110%); opacity:0 }
  10%{ opacity:1 } 90%{ opacity:1 }
  100%{ transform:translateX(-120%); opacity:0 }
}
#beltSpawn{
  position:absolute; right:8px; top:8px; width:1px; height:1px;
}
.spawn-item{
  position:absolute; right:16px; top:12px;
  font-size: 26px; line-height: 1;
  transform: translate(0,0);
  user-select:none; pointer-events:none;
}
/* Register */
.register{
  background: var(--card); border:1px solid var(--border); border-radius:12px;
  padding:10px; display:grid; gap:8px;
}
.register .display{
  font-family:ui-monospace, Menlo, Consolas, monospace;
  background: var(--bg); border:1px solid var(--border); border-radius:8px;
  padding:10px; font-size:1.1rem; letter-spacing:2px;
  display:flex; align-items:center; justify-content:space-between;
}
  .register-preview {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.register-preview .imgbox.small {
  width: 50px;
  height: 50px;
}
.register .kbd{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
.kkey{
  padding:14px 0; text-align:center; border-radius:10px;
  background: var(--surface); border:1px solid var(--border); font-weight:800; font-size:1.1rem;
  user-select:none; cursor:pointer;
}
  /* === Register: product preview === */
.product-preview{
  display:flex; gap:10px; align-items:center;
  border:1px solid var(--border);
  background: var(--surface);
  border-radius:10px;
  padding:8px;
}
.product-preview .product-img{
  width:56px; height:56px; min-width:56px;
  border:1px solid var(--border); border-radius:8px;
  background: var(--card);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
.product-preview .product-img img{
  width:100%; height:100%; object-fit:cover; display:block;
}
.product-preview .name{ font-weight:700; line-height:1.2 }
.kkey.wide{ grid-column:span 3; }

/* Light theme variants */
.light .checkout-area{ border-color:#e4e9f3; background:#f8f9fc; }
.light .avatar{ background:#fff; border-color:#e4e9f3; }
.light .belt{ background:#fff; border-color:#e6ebf5; }
.light .belt::before{
  background: repeating-linear-gradient(-45deg, rgba(0,0,0,.04) 0 12px, rgba(0,0,0,.02) 12px 24px);
}
.light .belt-item{ background:#f4f6fb; border-color:#e1e6f0; }
.light .belt-item .hint{ background:#eef1f6; border-color:#dfe6f2; color:#6b7a93; }
.light .register{ background:#ffffff; border-color:#e1e6f0; }
.light .register .display{ background:#f7f8fb; border-color:#e1e6f0; }
.light .kkey{ background:#f4f6fb; border-color:#e1e6f0; }

/* H-MART branding */
.brand{ display:flex; align-items:center; gap:10px; margin:0; font-size:1.1rem; letter-spacing:.2px; }
.hmart-badge{
  display:inline-flex; align-items:center; justify-content:center;
  padding:0 10px; height:28px; border-radius:4px;
  background:#E6002D; color:#fff; font-weight:900; font-size:.9rem;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  line-height:1; box-shadow:0 1px 0 rgba(0,0,0,.25) inset, 0 2px 6px rgba(0,0,0,.25);
  text-transform:uppercase;
}
/* === Scene / background === */
.scene{
  position: relative;
  height: 220px;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 10px;
  background: var(--card);
}
.scene-bg{
  position:absolute; inset:0;
  background-image: url('https://images.unsplash.com/photo-1586201375761-83865001e31b?q=80&w=1600&auto=format&fit=crop'); /* placeholder; swap with H-Mart-like shot */
  background-size: cover;
  background-position: center;
  filter: saturate(0.95) brightness(0.9);
  opacity: .85;
}
.light .scene-bg{ filter: saturate(1) brightness(1); opacity: .9; }

.customer-svg{
  position:absolute; bottom:10px; left:-140px; /* starts off-screen left */
  width: 200px; height: 200px;
}

/* Slight lift above background for your existing checkout-area */
.checkout-area{ position: relative; z-index: 2; }
/* optional: make any "red" buttons match the brand red */
.btn.red{ background:var(--accent); border-color:#b00020 }
  /* === Learn Section Code Styling === */
#learnCode {
  font-size: 1.6rem;
  letter-spacing: 4px;
  font-weight: 800;
  display: inline-block;
  padding: 4px 10px;
  border-radius: 8px;
  background: var(--card);
  color: var(--fg);
}
  /* === Register placeholder styling === */
#regDigits.placeholder {
  color: var(--muted);
  opacity: 0.8;
}
</style>
</head>
<body>
<script>
  // Apply saved theme ASAP so first paint matches user preference
  (function () {
    try {
      if (localStorage.getItem('THEME') === 'light') {
        document.body.classList.add('light');
      }
    } catch (e) {}
  })();
</script>
<header>
  <h1 class="brand">
    <span class="hmart-badge">H-Mart</span> PLU Trainer
  </h1>
<div class="row" style="margin-left:auto;flex-wrap:wrap;gap:8px">
  <span class="chip" id="welcomeChip">
    Welcome, <b id="welcomeName">—</b> (#<b id="welcomeNum">—</b>)
  </span>
  <button class="btn" id="editNameBtn" title="Edit name & number">📝</button>

  <button class="btn" id="themeToggle">🌙/☀️</button>
  <button class="btn" id="settingsBtn">⚙️</button>

    <label class="chip">
      <input type="checkbox" id="fxHaptics" checked> Haptics
    </label>

    <label class="chip">
      <input type="checkbox" id="fxSound"> Sound
    </label>

    <label class="chip">
      <input type="checkbox" id="srsMode"> SRS
      <span id="srsBadge" class="OFF">OFF</span>
    </label>
  </div>
</header>

<main>
  <!-- Learn -->
  <section id="panelLearn" class="panel active">
  <div class="card">
    <h2>Learn — Guided</h2>

    <!-- 🔽 Category filter goes here -->
    <div class="row" style="margin:6px 0">
      <label class="chip">Categories:
       <select id="learnCatFilter" multiple size="6" style="min-width:180px">
    <option value="">All</option>
  </select>
</label>
    </div>

    <div class="row">
      <div class="imgbox">
        <img id="learnImg" style="display:none">
        <span class="muted small" id="learnNoImg">No picture</span>
      </div>
      <div style="flex:1">
        <div><b id="learnName">—</b> <span class="muted">(<span id="learnCat">—</span>)</span></div>
        <div class="small muted" id="learnNotes"></div>
        <div class="row" style="margin-top:8px">
  <button class="btn" id="learnPrev">◀ Prev</button>
  <button class="btn" id="learnNext">Next ▶</button>
  <button class="btn" id="learnShow">Show Code</button>
  <span class="pill code" id="learnCode" style="display:none"></span>
  <button class="btn" id="learnPic">Add Picture</button>
  <button class="btn" id="learnProblem">⚠️ Problem</button>
</div>
      </div>
    </div>
  </div>
</section>

  <!-- Quiz -->
  <section id="panelQuiz" class="panel">
    <div class="card">
      <h2>Quiz — Register</h2>
      <div class="row" style="margin:6px 0">
        <div class="chip">Current: <b id="qName">—</b> <span class="muted">(<span id="qCat">—</span>)</span></div>
        <div class="chip">Target length: <b id="qLen">—</b></div>
        <div class="chip">Due: <b id="dueCount">0</b></div>
        <!-- FIX: unique ID for quiz badge -->
        <div class="chip">SRS: <b id="srsBadgeQuiz">OFF</b></div>
      </div>
      <div class="row">
        <input id="qInput" inputmode="numeric" placeholder="Enter PLU…" maxlength="5">
        <button class="btn" id="qSubmit">Enter</button>
        <button class="btn" id="qNext">Next ▶</button>
      </div>
      <div id="qFeedback" class="small" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Checkout -->
<section id="panelCheckout" class="panel">
  <div class="card">
    <h2>Checkout Game — Simulated Register</h2>
    
<div class="row">
  <button class="btn green" id="cgStart">Start</button>
  <button class="btn red" id="cgStop" disabled>Stop</button>

  <select id="cgPreset">
    <option value="rookie">Rookie</option>
    <option value="cashier" selected>Cashier</option>
    <option value="speed">Speed</option>
    <option value="expert">Expert</option>
  </select>

  <select id="cgTimer">
    <option value="0">Timer Off</option>
    <option value="30">30s</option>
    <option value="20">20s</option>
    <option value="10">10s</option>
    <option value="5">5s</option>
  </select>
</div>

    <label class="chip" style="margin-top:6px">
      <input type="checkbox" id="showCatHint"> Show Category Hint (next item)
    </label>

    <!-- AVATAR + BELT + REGISTER -->
    <div class="checkout-area" style="margin-top:8px">
      <!-- Avatar -->
      <div class="avatar" id="customerAvatar">
        <span class="muted small">Customer</span>
      </div>

      <!-- Conveyor belt -->
<div class="belt" id="belt">
  <div id="beltItems"></div>
  <div id="beltSpawn" aria-hidden="true"></div>
</div>

      <!-- Register -->
<div class="register">
  <!-- ✅ Product preview lives inside the register -->
  <div class="product-preview">
    <div class="product-img">
      <img id="cgPrevImg" alt="" style="display:none" />
      <span id="cgPrevNoImg" class="muted small">No picture</span>
    </div>
    <div class="product-meta">
      <div id="cgPrevName" class="name">—</div>
      <div class="muted small">(<span id="cgPrevCat">—</span>)</div>
    </div>
  </div>
<div class="display">
  <span class="muted small">PLU:</span>
  <span id="regMask" class="muted small" style="margin-left:6px"></span>
  <span id="regDigits" class="placeholder">—</span> <!-- ✅ added class -->
</div>

  <div class="kbd" id="regPad">
    <div class="kkey" data-key="1">1</div>
    <div class="kkey" data-key="2">2</div>
    <div class="kkey" data-key="3">3</div>
    <div class="kkey" data-key="4">4</div>
    <div class="kkey" data-key="5">5</div>
    <div class="kkey" data-key="6">6</div>
    <div class="kkey" data-key="7">7</div>
    <div class="kkey" data-key="8">8</div>
    <div class="kkey" data-key="9">9</div>
    <div class="kkey" data-key="0">0</div>
    <div class="kkey" data-key="back">⌫</div>
    <div class="kkey" data-key="clear">Clear</div>
    <div class="kkey wide" data-key="enter">Enter</div>
  </div>
</div>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="chip">Customer <b id="cgCust">0</b>/<b id="cgCustTotal">0</b></div>
      <div class="chip">Items <b id="cgItem">0</b>/<b id="cgItemTotal">0</b></div>
      <div class="chip">Streak <b id="cgStreak">0</b></div>
    </div>

<div class="row" style="margin-top:8px">
  <button class="btn" id="cgSkip">Skip</button>
</div>
<div id="cgFeedback" class="small" style="margin-top:6px"></div>
  </div>
  <input type="hidden" id="cgInput">
</section>
  <!-- Browse (added so the tab works) -->
  <section id="panelBrowse" class="panel">
    <div class="card">
      <h2>Browse</h2>
      <div class="row" style="margin:6px 0">
        <input id="searchBox" placeholder="Search items…">
        <select id="catFilter"></select>
        <label class="chip"><input type="checkbox" id="favOnly"> Favorites only</label>
        <span class="muted small" id="itemCount"></span>
      </div>
      <div id="browseList" class="list"></div>
    </div>
  </section>
  <!-- Leaderboard tab -->
<section id="panelLeaderboard" class="panel">
  <div class="card">
    <h2>Leaderboard</h2>

    <div class="row" style="margin:6px 0">
      <label class="chip">Difficulty:
        <select id="lbDiff">
          <option value="rookie">Rookie</option>
          <option value="cashier" selected>Cashier</option>
          <option value="speed">Speed</option>
          <option value="expert">Expert</option>
        </select>
      </label>
    </div>

    <table class="table">
      <thead>
        <tr><th>#</th><th>Name</th><th>Cashier</th><th>Best Streak</th></tr>
      </thead>
      <tbody id="lbTableBody">
        <tr><td colspan="4" class="muted small">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</section>
  <!-- Stats tab -->
  <section id="panelStats" class="panel">
    <div class="card">
      <h2>Stats <span class="muted small" id="statsFor"></span></h2>
      <div id="stats"></div>
      <div class="row" style="margin-top:10px; gap:8px">
        <button class="btn" id="exportData">💾 Save Backup</button>
        <button class="btn" id="shareStats">📤 Share Stats</button>
      </div>
    </div>
  </section>

  <div id="settingsPanel" class="card" style="display:none; position:fixed; right:10px; top:56px; width:260px; z-index:20">
  <h3 style="margin:6px 0">Settings</h3>
  <div class="row">
    <button class="btn" id="toggleTheme">Toggle Light/Dark</button>
    <button class="btn" id="closeSettings">Close</button>
  </div>
  <p class="small muted" style="margin-top:8px">More settings can go here later.</p>
</div>
</main>

<!-- Bottom tabs -->
<nav class="tabs">
  <button class="tabbtn active" data-tab="panelLearn">Learn</button>
  <button class="tabbtn" data-tab="panelQuiz">Quiz</button>
  <button class="tabbtn" data-tab="panelCheckout">Checkout</button>
  <button class="tabbtn" data-tab="panelBrowse">Browse</button>
  <button class="tabbtn" data-tab="panelLeaderboard">Leaderboard</button>
  <button class="tabbtn" data-tab="panelStats">Stats</button>
</nav>
<!-- 🔽🔽🔽 PASTE your full master JSON here (the entire array) and save -->
<script id="seed" type="application/json">[
  {"name":"Cosmic Crisp Apple","code":"2773","category":"Apple","notes":""},
  {"name":"Gala Apple","code":"2781","category":"Apple","notes":""},
  {"name":"Fuji Apple","code":"2782","category":"Apple","notes":""},
  {"name":"Fuji Apple (Organic)","code":"27829","category":"Apple","notes":"Organic → 9 at end"},
  {"name":"Red Delicious Apple","code":"2784","category":"Apple","notes":""},
  {"name":"Golden Delicious Apple","code":"2785","category":"Apple","notes":""},
  {"name":"Granny Smith Apple","code":"2788","category":"Apple","notes":""},
  {"name":"Envy Apple","code":"2792","category":"Apple","notes":""},
  {"name":"Honey Crisp Apple","code":"2794","category":"Apple","notes":""},
  {"name":"Pink Lady Apple","code":"2795","category":"Apple","notes":""},
  {"name":"Sugarbee Apple","code":"2807","category":"Apple","notes":""},

  {"name":"Asian Pear","code":"2725","category":"Pear","notes":""},
  {"name":"Yali Pear","code":"2726","category":"Pear","notes":""},
  {"name":"Fragrant Pear","code":"2727","category":"Pear","notes":""},
  {"name":"Korean Pear","code":"2728","category":"Pear","notes":""},
  {"name":"Korean Golden Pear","code":"2729","category":"Pear","notes":""},
  {"name":"Bosc Pear","code":"2731","category":"Pear","notes":""},
  {"name":"D’Anjuor Pear","code":"2732","category":"Pear","notes":""},
  {"name":"Bartlett Pear","code":"2733","category":"Pear","notes":""},
  {"name":"Red D’Anjour","code":"2741","category":"Pear","notes":""},
  {"name":"Sand Pear","code":"2744","category":"Pear","notes":""},
  {"name":"Apple Pear","code":"2746","category":"Pear","notes":""},

  {"name":"Korean Melon","code":"2670","category":"Melon","notes":""},
  {"name":"Hami Melon","code":"2671","category":"Melon","notes":""},
  {"name":"Tuscan Melon","code":"2687","category":"Melon","notes":""},
  {"name":"Cantaloupe","code":"2685","category":"Melon","notes":""},

  {"name":"Watermelon","code":"2811","category":"Watermelon","notes":""},

  {"name":"Fuyu Persimmon","code":"2651","category":"Persimmon","notes":""},
  {"name":"Quince","code":"2700","category":"Quince","notes":""},

  {"name":"Apple Banana","code":"2709","category":"Banana","notes":""},
  {"name":"Red Banana","code":"2710","category":"Banana","notes":""},
  {"name":"Yellow Banana","code":"2711","category":"Banana","notes":""},
  {"name":"Baby Banana","code":"2712","category":"Banana","notes":""},
  {"name":"Thai Banana","code":"2715","category":"Banana","notes":""},
  {"name":"Burro Banana","code":"2716","category":"Banana","notes":""},
  {"name":"Green Banana","code":"2718","category":"Banana","notes":""},

  {"name":"Green Plantain","code":"2719","category":"Plantain","notes":""},
  {"name":"Yellow Plantain","code":"2720","category":"Plantain","notes":""},

  {"name":"White Peach","code":"2760","category":"Peach","notes":""},
  {"name":"Yellow Peach","code":"2761","category":"Peach","notes":""},
  {"name":"White Donut Peach","code":"2763","category":"Peach","notes":""},
  {"name":"Yellow Nectarine","code":"2767","category":"Nectarine","notes":""},
  {"name":"White Nectarine","code":"2769","category":"Nectarine","notes":""},

  {"name":"Avocado Hass","code":"2839","category":"Avocado","notes":""},
  {"name":"Organic Avocado Hass","code":"28399","category":"Avocado","notes":"Organic → 9 at end"},

  {"name":"Cacao Fruit","code":"2845","category":"Tropical Fruit","notes":""},
  {"name":"Mango","code":"2847","category":"Mango","notes":""},
  {"name":"Green Mango","code":"2850","category":"Mango","notes":""},
  {"name":"Mango Box","code":"28473","category":"Mango","notes":"Box code"},

  {"name":"White Coconut","code":"2857","category":"Coconut","notes":""},
  {"name":"Brown Coconut","code":"2858","category":"Coconut","notes":""},
  {"name":"Green Coconut","code":"2859","category":"Coconut","notes":""},

  {"name":"Papaya","code":"2862","category":"Papaya","notes":""},
  {"name":"Hawaiian Papaya","code":"2863","category":"Papaya","notes":""},
  {"name":"Green Papaya","code":"2864","category":"Papaya","notes":""},

  {"name":"Pomegranate","code":"2808","category":"Pomegranate","notes":""},

  {"name":"Fresh Durian","code":"2870","category":"Tropical Fruit","notes":""},
  {"name":"Frozen Durian","code":"28708","category":"Tropical Fruit","notes":""},
  {"name":"Sapote (Mamey)","code":"2872","category":"Tropical Fruit","notes":""},
  {"name":"Dragon Fruit White Flesh","code":"2874","category":"Tropical Fruit","notes":""},
  {"name":"Longan","code":"2875","category":"Tropical Fruit","notes":""},
  {"name":"Soursop","code":"2876","category":"Tropical Fruit","notes":""},
  {"name":"Rambutan","code":"2877","category":"Tropical Fruit","notes":""},
  {"name":"Guava","code":"2878","category":"Tropical Fruit","notes":""},
  {"name":"Cherimoya","code":"2879","category":"Tropical Fruit","notes":""},
  {"name":"Mangosteen","code":"2880","category":"Tropical Fruit","notes":""},
  {"name":"Breadfruit","code":"2881","category":"Tropical Fruit","notes":""},
  {"name":"Yellow Dragon Fruit","code":"2883","category":"Tropical Fruit","notes":""},

  {"name":"Pineapple","code":"2868","category":"Pineapple","notes":""},

  {"name":"Sweet Lime","code":"2886","category":"Citrus","notes":""},
  {"name":"Lime","code":"2887","category":"Citrus","notes":""},
  {"name":"Lemon","code":"2888","category":"Citrus","notes":""},

  {"name":"Korean Hallabong","code":"2884","category":"Orange","notes":""},
  {"name":"Navel Orange","code":"2889","category":"Orange","notes":""},
  {"name":"Cara Cara Orange","code":"2896","category":"Orange","notes":""},
  {"name":"Minneola Orange","code":"2898","category":"Orange","notes":""},
  {"name":"Blood Orange","code":"2899","category":"Orange","notes":""},
  {"name":"Orri Mandarin","code":"2900","category":"Mandarin","notes":""},
  {"name":"Sour Orange","code":"2912","category":"Orange","notes":""},

  {"name":"Yellow Plum","code":"2919","category":"Plum","notes":""},
  {"name":"Red Plum","code":"2921","category":"Plum","notes":""},
  {"name":"Dinosaur Plum","code":"2922","category":"Plum","notes":""},

  {"name":"Pink Grapefruit","code":"2948","category":"Grapefruit","notes":""},

  {"name":"Florida Pomelo","code":"2953","category":"Pomelo","notes":""},
  {"name":"Chinese Pomelo","code":"2954","category":"Pomelo","notes":""},
  {"name":"Pomelo","code":"2955","category":"Pomelo","notes":""},

  {"name":"Cotton Candy Grape","code":"2969","category":"Grape","notes":""},
  {"name":"Green Seedless Grape","code":"2971","category":"Grape","notes":""},
  {"name":"Red Seedless Grape","code":"2972","category":"Grape","notes":""},

  {"name":"Plain Parsley","code":"2349","category":"Herbs","notes":""},
  {"name":"Cilantro","code":"2350","category":"Herbs","notes":""},
  {"name":"Curly Parsley","code":"2351","category":"Herbs","notes":""},

  {"name":"Gray Squash","code":"2411","category":"Squash","notes":""},
  {"name":"Korean Squash","code":"2412","category":"Squash","notes":""},
  {"name":"Kabocha","code":"2418","category":"Squash","notes":""},
  {"name":"Calabaza","code":"2419","category":"Squash","notes":""},
  {"name":"Spaghetti Squash","code":"2421","category":"Squash","notes":""},
  {"name":"Butternut Squash","code":"2423","category":"Squash","notes":""},
  {"name":"Acorn Squash","code":"2424","category":"Squash","notes":""},

  {"name":"Watercress","code":"2455","category":"Leafy Greens","notes":""},
  {"name":"Turnip Green","code":"2456","category":"Leafy Greens","notes":""},
  {"name":"Leek","code":"2458","category":"Leafy Greens","notes":""},
  {"name":"Dill","code":"2464","category":"Herbs","notes":""},
  {"name":"Radicchio","code":"2509","category":"Leafy Greens","notes":""},
  {"name":"Red Beet Bunch","code":"2472","category":"Root Vegetable","notes":""},
  {"name":"Red Beet","code":"2473","category":"Root Vegetable","notes":""},

  {"name":"Kale","code":"2490","category":"Leafy Greens","notes":""},
  {"name":"Curly Kale","code":"2491","category":"Leafy Greens","notes":""},
  {"name":"White Turnip","code":"2495","category":"Root Vegetable","notes":""},
  {"name":"Green Onion","code":"2498","category":"Onion","notes":""},

  {"name":"White Garlic","code":"2525","category":"Garlic","notes":""},
  {"name":"Ginger","code":"2530","category":"Root Vegetable","notes":""},

  {"name":"White Onion","code":"2538","category":"Onion","notes":""},
  {"name":"Red Onion","code":"2539","category":"Onion","notes":""},
  {"name":"Yellow Onion","code":"2540","category":"Onion","notes":""},
  {"name":"Shallot Onion","code":"2547","category":"Onion","notes":""},

  {"name":"Potato","code":"2557","category":"Potato","notes":""},
  {"name":"Red Potato","code":"2558","category":"Potato","notes":""},
  {"name":"White Potato","code":"2559","category":"Potato","notes":""},

  {"name":"American Yam","code":"2560","category":"Yam","notes":""},
  {"name":"Korean Sweet Potato","code":"2565","category":"Yam","notes":""},
  {"name":"Korean Sweet Potato Box","code":"25656","category":"Yam","notes":"Box code"},

  {"name":"Yucca","code":"2581","category":"Root Vegetable","notes":""},
  {"name":"Jicama","code":"2582","category":"Root Vegetable","notes":""},
  {"name":"Yellow Yam","code":"2584","category":"Yam","notes":""},
  {"name":"White Yam","code":"2585","category":"Yam","notes":""},
  {"name":"Batata","code":"2586","category":"Yam","notes":""},
  {"name":"Yautia","code":"2587","category":"Yam","notes":""},
  {"name":"Yampi","code":"2590","category":"Yam","notes":""},
  {"name":"Hawaiian Purple Yam","code":"2591","category":"Yam","notes":""},

  {"name":"Small Taro (Eddo)","code":"2593","category":"Root Vegetable","notes":""},
  {"name":"Big Taro (Malanga)","code":"2594","category":"Root Vegetable","notes":""},
  {"name":"Name Yam","code":"2595","category":"Yam","notes":""},
  {"name":"Malanga Blanca","code":"2596","category":"Root Vegetable","notes":""},

  {"name":"Pandan Leaf","code":"2410","category":"Herbs / Aromatics","notes":""},

  {"name":"Banana Flower","code":"2713","category":"Flowers / Special Veggies","notes":""},
  {"name":"Okra","code":"2075","category":"Pods","notes":""},
  {"name":"Chinese Okra","code":"2076","category":"Pods","notes":""},

  {"name":"Holland Red Pepper","code":"2122","category":"Pepper","notes":""},
  {"name":"Holland Yellow Pepper","code":"2123","category":"Pepper","notes":""},
  {"name":"Holland Green Pepper","code":"2124","category":"Pepper","notes":""},
  {"name":"Holland Orange Pepper","code":"2125","category":"Pepper","notes":""},

  {"name":"Carrot","code":"2163","category":"Root Vegetable","notes":""},
  {"name":"Jujube","code":"2173","category":"Fruit","notes":""},
  {"name":"Korean Radish","code":"2175","category":"Root Vegetable","notes":""},
  {"name":"Daikon Radish (Chinese)","code":"2179","category":"Root Vegetable","notes":""},

  {"name":"Napa Cabbage","code":"2195","category":"Cabbage","notes":""},
  {"name":"Chinese Chives","code":"2221","category":"Herbs / Aromatics","notes":""},

  {"name":"Broccoli","code":"2231","category":"Brassica","notes":""},
  {"name":"White Cauliflower","code":"2234","category":"Brassica","notes":""},
  {"name":"Purple Cauliflower","code":"2235","category":"Brassica","notes":""},
  {"name":"Chinese Cauliflower","code":"2239","category":"Brassica","notes":""},

  {"name":"Red Leaf Lettuce","code":"2242","category":"Lettuce","notes":""},
  {"name":"Green Leaf Lettuce","code":"2243","category":"Lettuce","notes":""},
  {"name":"Romaine Lettuce","code":"2245","category":"Lettuce","notes":""},

  {"name":"Celery","code":"2252","category":"Stalks","notes":""},

  {"name":"Asparagus","code":"2262","category":"Asparagus","notes":""},
  {"name":"White Asparagus","code":"2263","category":"Asparagus","notes":""},
  {"name":"Purple Asparagus","code":"2264","category":"Asparagus","notes":""},

  {"name":"Green Cabbage","code":"2268","category":"Cabbage","notes":""},
  {"name":"White Cabbage","code":"2269","category":"Cabbage","notes":""},
  {"name":"Savoy Cabbage","code":"2271","category":"Cabbage","notes":""},

  {"name":"Yellow Corn","code":"2285","category":"Corn","notes":""},
  {"name":"Chayote","code":"2294","category":"Chayote","notes":""},

  {"name":"Green Bean","code":"2308","category":"Beans","notes":""},
  {"name":"Flat Bean","code":"2310","category":"Beans","notes":""},

  {"name":"Tomatoes","code":"2325","category":"Tomato","notes":""},
  {"name":"Plum Tomatoes","code":"2326","category":"Tomato","notes":""},
  {"name":"Stem Tomatoes","code":"2327","category":"Tomato","notes":""},
  {"name":"Beef Tomato","code":"2328","category":"Tomato","notes":""},
  {"name":"Parsnip Root","code":"2346","category":"Root Vegetable","notes":""},
  {"name":"Stem Tomato Box","code":"23273","category":"Tomato","notes":"Box code"}
]</script>
<!-- 🔼🔼🔼 End master list embed -->
<!-- GSAP for smooth animations (put before your main scripts) -->
<script>
// ---------------- Utilities & State ----------------
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
const store = {
  save(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  get(k,f){ try{ return JSON.parse(localStorage.getItem(k)) ?? f } catch{ return f } },
  del(k){ localStorage.removeItem(k); }
};const PROFILE_KEY = 'PROFILE_V1';
let PROFILE = store.get(PROFILE_KEY, { name: '', cashier: '' });

function updateWelcomeUI(){
  $("#welcomeName").textContent = PROFILE?.name || '—';
  $("#welcomeNum").textContent  = PROFILE?.cashier || '—';
}

// Show in Stats tab too
function updateStatsWhoAmI(){
  const host = document.getElementById('stats');
  if (!host) return;
  const who = (PROFILE?.name) ? `${PROFILE.name}${PROFILE.cashier ? ' (#'+PROFILE.cashier+')':''}` : '—';
  let el = document.getElementById('whoamiLine');
  if (!el){
    el = document.createElement('div');
    el.id = 'whoamiLine';
    el.className = 'chip';
    el.style.marginBottom = '8px';
    host.prepend(el);
  }
  el.innerHTML = `User: <b>${who}</b>`;
}
// Open prompt when user clicks 📝
document.getElementById("editNameBtn")?.addEventListener("click", async ()=>{
  let name = prompt("Enter your name:", PROFILE.name || "");
  if (!name) return;
  let cashier = prompt("Enter your cashier number:", PROFILE.cashier || "");
  cashier = cashier.replace(/\D/g,"").slice(0,8);

  PROFILE = { name, cashier };
  store.save(PROFILE_KEY, PROFILE);
  updateWelcomeUI();
  updateStatsWhoAmI();

  // ✅ NEW: also sync USER_INFO to match PROFILE
  setUserInfo(name, cashier);

  // ✅ Keep leaderboard name/cashier in sync
  if (window.syncLeaderboardName) {
    try { await window.syncLeaderboardName(); } catch(e){}
  }
});
  // ---------- User info (welcome + cashier number) ----------
const USER_INFO_KEY = 'USER_INFO';

function getUserInfo(){
  return store.get(USER_INFO_KEY, { name:"", number:"" });
}
function setUserInfo(name, number){
  const cleanName = String(name||"").trim();
  const cleanNum  = String(number||"").trim();
  store.save(USER_INFO_KEY, { name: cleanName, number: cleanNum });
  updateWelcome();
  updateStatsHeader();
}
function updateWelcome(){
  const { name, number } = getUserInfo();
  document.getElementById("welcomeName").textContent = name || "—";
  document.getElementById("welcomeNum").textContent  = number || "—";
}
function askForUserInfo(initial=false){
  const { name, number } = getUserInfo();
  const newName = prompt("Enter your name:", name || "");
  if (newName == null) return; // user cancelled
  const newNum  = prompt("Enter your cashier number:", number || "");
  if (newNum == null) return;  // user cancelled
  if (newName.trim() && newNum.trim()) {
    setUserInfo(newName, newNum);
  } else if (initial) {
    // First run and they left it blank—just update UI with placeholders
    updateWelcome();
    updateStatsHeader();
  }
}

// Tie the Stats panel label to the saved user
function updateStatsHeader(){
  const t = document.getElementById("statsFor");
  if (!t) return;
  const { name, number } = getUserInfo();
  if (name || number) {
    const disp = `${name || '—'}${number ? ' (#'+number+')' : ''}`;
    t.textContent = `— for ${disp}`;
  } else {
    t.textContent = "";
  }
}
// First load: if missing, ask once (slight delay so UI is painted)
(function initWelcome(){
  updateWelcome();
  updateStatsHeader();
  const { name, number } = getUserInfo();
  if (!name || !number) {
    setTimeout(()=>askForUserInfo(true), 400);
  }
})();
// ---------------- Settings + Theme ----------------

// Helpers so both buttons use the same logic
function setTheme(mode) {
  if (mode === 'light') {
    document.body.classList.add('light');
  } else {
    document.body.classList.remove('light');
  }
  try { localStorage.setItem('THEME', mode); } catch(e){}
}

function toggleTheme() {
  const light = document.body.classList.toggle('light');
  try { localStorage.setItem('THEME', light ? 'light' : 'dark'); } catch(e){}
}

// Bind theme button (header + settings panel)
document.getElementById('toggleTheme')?.addEventListener('click', toggleTheme);

// Settings button behavior (open/close the panel)
const settingsBtn   = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');

document.getElementById('closeSettings')?.addEventListener('click', ()=>{
  if (settingsPanel) settingsPanel.style.display = 'none';
});

settingsBtn?.addEventListener('click', ()=>{
  if (!settingsPanel) return;
  const cur = settingsPanel.style.display;
  settingsPanel.style.display = (cur && cur !== 'none') ? 'none' : 'block';
});
// --- Format helpers / pretty stats text ---
function fmt(n){ return Number(n||0).toLocaleString(); }
function accuracyPct(stats){ return stats.seen ? Math.round(100 * stats.correct / stats.seen) : 0; }
function prettyStatsText(){
  const acc = accuracyPct(STATS);
  const lines = [
    "PLU Trainer — Current Stats",
    `• Seen: ${fmt(STATS.seen)}`,
    `• Correct: ${fmt(STATS.correct)}`,
    `• Accuracy: ${acc}%`,
    `• Current Streak: ${fmt(STATS.streak)}`,
    `• Best Streak: ${fmt(STATS.bestStreak)}`,
    `• Timestamp: ${new Date().toLocaleString()}`
  ];
  return lines.join("\n");
}

// --- Feedback (Haptics + Sound) ---
function giveFeedback(type="light") {
  if ($("#fxHaptics")?.checked && navigator.vibrate) {
    if (type === "success") navigator.vibrate([30]);
    else if (type === "error") navigator.vibrate([60, 40, 60]);
    else navigator.vibrate(20);
  }
  if ($("#fxSound")?.checked) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "square";
    osc.frequency.value = (type === "success") ? 880 : (type === "error" ? 220 : 440);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15);
    osc.stop(ctx.currentTime + 0.15);
  }
}

// --- Title Case for names/categories ---
function toTitle(s){
  return s.toLowerCase().replace(/([\p{L}\p{N}]+)/gu, w=>{
    return w.charAt(0).toUpperCase()+w.slice(1);
  }).replace(/\bD’anjou\b/giu,'D’Anjou').replace(/\bD’anjour\b/giu,'D’Anjour');
}

// ---------- Load DATA from seed once ----------
let DATA = store.get('DATA_BAKED', null);
if(!DATA){
  const raw = $("#seed").textContent.trim();
  DATA = JSON.parse(raw).map(x=>({
    ...x,
    name: toTitle(String(x.name || "")),
    code: String(x.code || ""),
    category: toTitle(String(x.category || "")),
    notes: x.notes || "",
    image: x.image || ""
  }));
  store.save('DATA_BAKED', DATA);
}

// Item counter (filtered/total)
const TOTAL_ITEMS = DATA.length;
function updateItemCount(filteredCount = TOTAL_ITEMS){
  const c = document.getElementById('itemCount');
  if (c) c.textContent = `(${filteredCount}/${TOTAL_ITEMS})`;
}

// Favorites, Problem items & Stats
const FAV = new Set(store.get('FAV', []));
function saveFav(){ store.save('FAV', [...FAV]); }
const STATS = store.get('STATS', {seen:0,correct:0,streak:0,bestStreak:0});
function saveStats(){ store.save('STATS', STATS); }

// Problem items (user-flagged)
const PROBLEM = new Set(store.get('PROBLEM', []));
function saveProblem(){ store.save('PROBLEM', [...PROBLEM]); }
// Theme toggle
$("#themeToggle").onclick = ()=>{
  document.body.classList.toggle('light');
  localStorage.setItem('THEME', document.body.classList.contains('light') ? 'light':'dark');
};
if(localStorage.getItem('THEME')==='light') document.body.classList.add('light');

// Tabs
$$('.tabbtn').forEach(b=>b.onclick=()=>{
  $$('.tabbtn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  $$('.panel').forEach(p=>p.classList.remove('active'));
  $('#'+b.dataset.tab).classList.add('active');
});

// --------------- Learn (filtered + shuffled) ----------------
(function(){
  // tiny local shuffle so we don't depend on the quiz shuffle
  function shuffleLocal(a){
    const b = [...a];
    for (let i=b.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [b[i], b[j]] = [b[j], b[i]];
    }
    return b;
  }

  // state
  let learnOrder  = [];         // current shuffled pool
  let learnIndex  = 0;          // pointer in learnOrder

  // nodes we update a lot
  const imgEl    = document.getElementById('learnImg');
  const noImg    = document.getElementById('learnNoImg');
  const nameEl   = document.getElementById('learnName');
  const catEl    = document.getElementById('learnCat');
  const notesEl  = document.getElementById('learnNotes');
  const codeBtn  = document.getElementById('learnShow');
  const codeTag  = document.getElementById('learnCode');
  const picBtn   = document.getElementById('learnPic');
  const prevBtn  = document.getElementById('learnPrev');
  const nextBtn  = document.getElementById('learnNext');
  const catSelect= document.getElementById('learnCatFilter');
  const problemBtn = document.getElementById('learnProblem');

  // build dropdown options once
function buildLearnCatFilter(){
  if (!catSelect) return;
  const cats = Array.from(new Set(DATA.map(d=>d.category))).sort();
  catSelect.innerHTML =
    `<option value="">All</option>
     <option value="__PROBLEM__">Problem Items</option>` +
    cats.map(c=>`<option>${c}</option>`).join('');
}
function selectedCats(){
  if (!catSelect) return [];
  const vals = [...catSelect.selectedOptions].map(o=>o.value);
  // If "All" is the only thing (or nothing) selected, treat as no filter
  if (!vals.length || (vals.length === 1 && vals[0] === '')) return [];
  return vals;
}
  // (re)build a shuffled order for the current filter
function rebuildLearnOrder(){
  const sel = selectedCats(); // [] means no filter (all)
  let pool;

  if (!sel.length){
    pool = DATA;
  } else {
    const wantsProblem = sel.includes('__PROBLEM__');
    const catSet = new Set(sel.filter(v=>v && v !== '__PROBLEM__'));
    pool = DATA.filter(it => {
      const inCats = catSet.size ? catSet.has(it.category) : false;
      const inProb = wantsProblem ? PROBLEM.has(it.code) : false;
      return inCats || inProb;
    });
  }

  learnOrder = shuffleLocal(pool);
  learnIndex = 0;
}

  // current item helper
  function curItem(){
    if (!learnOrder.length) return null;
    return learnOrder[learnIndex % learnOrder.length];
  }

  // show / hide the big code pill
  function hideCode(){
    if (!codeTag) return;
    codeTag.style.display = 'none';
  }
  function showCode(codeStr){
    if (!codeTag) return;
    codeTag.textContent = codeStr;
    codeTag.style.display = 'inline-block';
    // make it extra readable
    codeTag.style.fontSize = '1.6rem';
    codeTag.style.letterSpacing = '4px';
    codeTag.style.fontWeight = '800';
    // tap to copy
    codeTag.title = "Tap to copy";
  }

  // main renderer
  function showLearn(){
    const it = curItem();
    if (!it){
      nameEl.textContent = '—';
      catEl.textContent  = '—';
      notesEl.textContent= '';
      if (imgEl){ imgEl.style.display='none'; }
      if (noImg){ noImg.style.display='inline'; noImg.textContent='No items'; }
      hideCode();
      return;
    }

    nameEl.textContent = it.name;
    catEl.textContent  = it.category;
    notesEl.textContent= it.notes || '';

    // image block
    if (it.image){
      imgEl.src = it.image;
      imgEl.style.display = 'block';
      if (noImg) noImg.style.display = 'none';
    } else {
      imgEl.style.display = 'none';
      if (noImg){ noImg.style.display = 'inline'; noImg.textContent = 'No picture'; }
    }
// reflect Problem state on the button for the current item
if (problemBtn) {
  const flagged = PROBLEM.has(it.code);
  problemBtn.textContent = flagged ? '✓ Problem' : '⚠ Problem';
  problemBtn.title = flagged ? 'Click to unmark as problem' : 'Click to mark as problem';
  problemBtn.classList.toggle('active', flagged);
}
    // hide code by default until user taps "Show Code"
    hideCode();
  }

  // wire controls
  prevBtn?.addEventListener('click', ()=>{
    if (!learnOrder.length) return;
    learnIndex = (learnIndex - 1 + learnOrder.length) % learnOrder.length;
    showLearn();
  });

  nextBtn?.addEventListener('click', ()=>{
    if (!learnOrder.length) return;
    learnIndex = (learnIndex + 1) % learnOrder.length;
    // when we wrap back to 0, reshuffle so the order changes each pass
    if (learnIndex === 0) learnOrder = shuffleLocal(learnOrder);
    showLearn();
  });

  codeBtn?.addEventListener('click', ()=>{
    const it = curItem();
    if (!it) return;
    // toggle: if visible, hide; if hidden, show
    if (codeTag.style.display === 'none' || codeTag.style.display === ''){
      showCode(it.code);
    } else {
      hideCode();
    }
  });

  // click the code pill to copy
  codeTag?.addEventListener('click', async ()=>{
    try {
      await navigator.clipboard.writeText(codeTag.textContent.trim());
      codeTag.title = "Copied!";
      setTimeout(()=>{ codeTag.title = "Tap to copy"; }, 900);
    } catch(e){}
  });

  // add picture
  picBtn?.addEventListener('click', ()=>{
    const it = curItem();
    if (!it) return;
    const url = prompt("Paste image URL for: "+it.name);
    if (!url) return;
    it.image = url;
    // persist back to local baked data
    const idx = DATA.findIndex(d=>d.code===it.code);
    if (idx >= 0){ DATA[idx].image = url; store.save('DATA_BAKED', DATA); }
    showLearn();
  });
problemBtn?.addEventListener('click', ()=>{
  const it = curItem();
  if (!it) return;
  if (PROBLEM.has(it.code)) {
    PROBLEM.delete(it.code);
  } else {
    PROBLEM.add(it.code);
  }
  saveProblem();
  showLearn(); // refresh button label/state
});
  // category filter change
catSelect?.addEventListener('change', ()=>{
  rebuildLearnOrder();
  showLearn();
});

  // init
  buildLearnCatFilter();
  rebuildLearnOrder();
  showLearn();
})();
// --------- Spaced Repetition (SRS) ----------
const SRS = store.get('SRS', {}); // code -> {ef, reps, intervalDays, dueTs}
function saveSRS(){ store.save('SRS', SRS); }
const nowTs = ()=>Date.now();
const days = n=>n*24*60*60*1000;
function srsGet(code){
  if(!SRS[code]) SRS[code] = { ef:2.5, reps:0, intervalDays:0, dueTs: nowTs() };
  return SRS[code];
}
// SM-2 inspired, simplified
function srsUpdate(code, correct){
  const r = srsGet(code);
  if(correct){
    r.reps += 1;
    if(r.reps === 1) r.intervalDays = 1;
    else if(r.reps === 2) r.intervalDays = 6;
    else r.intervalDays = Math.round(Math.max(1, r.intervalDays * r.ef));
    r.ef = Math.min(2.8, r.ef + 0.1);
  } else {
    r.reps = 0; r.intervalDays = 1; r.ef = Math.max(1.3, r.ef - 0.3);
  }
  r.dueTs = nowTs() + days(r.intervalDays);
  saveSRS();
}
function srsDueItems(){
  const t = nowTs(); const due=[];
  for(const it of DATA){ if(srsGet(it.code).dueTs <= t) due.push(it); }
  return due;
}
function updateDueBadge(){
  const el = document.getElementById('dueCount');
  if(el) el.textContent = srsDueItems().length;
}

// --------------- Quiz ----------------
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function buildQuizOrder(){
  if ($("#srsMode")?.checked){
    const due = srsDueItems();
    if (due.length) return shuffle(due);
  }
  return shuffle([...DATA]);
}
let q = { i: 0, order: buildQuizOrder() };
function showQuiz(){
  if (q.i >= q.order.length){ q.i = 0; q.order = buildQuizOrder(); }
  const it = q.order[q.i % q.order.length];
  $("#qName").textContent = it.name; $("#qCat").textContent = it.category; $("#qLen").textContent = it.code.length;
  $("#qInput").value = ""; $("#qFeedback").textContent = "";
}
function submitQuiz(){
  const it  = q.order[q.i % q.order.length];
  const val = $("#qInput").value.trim();
  const ok  = (val === it.code);
  $("#qFeedback").innerHTML = ok ? `✅ Correct: ${it.code}` : `❌ ${val||'—'} → ${it.code}`;
  srsUpdate(it.code, ok); updateDueBadge();
  if (ok) giveFeedback("success"); else giveFeedback("error");
  STATS.seen++; if (ok){ STATS.correct++; STATS.streak++; STATS.bestStreak=Math.max(STATS.bestStreak, STATS.streak); } else { STATS.streak=0; }
  saveStats(); renderStats();
  q.i++; showQuiz();
}
$("#qSubmit").onclick = submitQuiz;
$("#qNext").onclick   = ()=>{ q.i++; showQuiz(); };
$("#qInput").addEventListener('keydown', e=>{ if(e.key==='Enter') submitQuiz(); });
showQuiz(); updateDueBadge();

// === Customer avatars (PNG files you uploaded to /avatars) ===
const AVATARS = [
  'avatars/avatar_01.png','avatars/avatar_02.png','avatars/avatar_03.png',
  'avatars/avatar_04.png','avatars/avatar_05.png','avatars/avatar_06.png',
  'avatars/avatar_07.png','avatars/avatar_08.png','avatars/avatar_09.png',
  'avatars/avatar_10.png'
];

function setRandomAvatar(){
  const src = AVATARS[Math.floor(Math.random()*AVATARS.length)];
  const el  = document.getElementById('customerAvatar');
  if (!el) return;

  const img = new Image();
  img.alt = "customer";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "cover";
  img.style.borderRadius = "12px";

  img.onload = () => { el.innerHTML = ""; el.appendChild(img); };
  img.onerror = () => { el.textContent = "🛒"; }; // fallback glyph
  img.src = src;
}

// Preload avatars to avoid flashes
(function preloadAvatars(){
  AVATARS.forEach(src=>{ const i=new Image(); i.src=src; });
})();
// Category → emoji icons for belt preview
const CAT_ICON = {
  // Fruits
  "Apple":"🍎","Pear":"🍐","Quince":"🍏","Banana":"🍌","Plantain":"🍌","Mango":"🥭","Avocado":"🥑",
  "Peach":"🍑","Nectarine":"🍑","Plum":"🟣","Grape":"🍇","Pomegranate":"🔴","Persimmon":"🧡",
  "Papaya":"🧡","Pineapple":"🍍","Coconut":"🥥","Orange":"🍊","Mandarin":"🍊","Grapefruit":"🍊",
  "Pomelo":"🍊","Melon":"🍈","Watermelon":"🍉","Tropical Fruit":"🥭",

  // Vegetables
  "Tomato":"🍅","Onion":"🧅","Garlic":"🧄","Potato":"🥔","Yam":"🍠","Carrot":"🥕","Cabbage":"🥬",
  "Brassica":"🥦","Lettuce":"🥬","Leafy Greens":"🥬","Stalks":"🥬","Asparagus":"🥬","Corn":"🌽",
  "Beans":"🫘","Pods":"🫛","Pepper":"🫑","Chayote":"🥗","Flowers / Special Veggies":"🌺",

  // Herbs
  "Herbs":"🌿","Herbs / Aromatics":"🌿","Pandan":"🌿","Pandan Leaf":"🌿",

  // Fallback
  "Default":"🛒"
};

// Safe lookup
function iconFor(it){
  return CAT_ICON[it.category] || CAT_ICON["Default"];
}
  // ✅ Add setPreview here, right after the belt helpers
function setPreview(it){
  $("#cgPrevName").textContent = it ? it.name : "—";
  $("#cgPrevCat").textContent  = it ? it.category : "—";

  const img = $("#cgPrevImg");
  const no  = $("#cgPrevNoImg");
  if (it && it.image){
    img.src = it.image; img.style.display = "block";
    if (no) no.style.display = "none";
  } else {
    img.style.display = "none";
    if (no) no.style.display = "inline";
  }
}
// --------------- Checkout Game ----------------

// ✅ Belt helpers (keep these)
function renderBelt(queue, showHint=false){
  const belt = document.getElementById('beltItems');
  if(!belt) return;
  belt.innerHTML = '';

  const upcoming = queue.slice(0, 6);
  if (!upcoming.length){
    const empty = document.createElement('div');
    empty.className = 'belt-item';
    empty.textContent = '—';
    empty.style.bottom = '15px';
    belt.appendChild(empty);
    return;
  }

  upcoming.forEach((it, i)=>{
    const div = document.createElement('div');
    div.className = 'belt-item';
    div.textContent = (i === 0 && document.getElementById('showCatHint')?.checked && showHint) ? iconFor(it) : '📦';

    if (i === 0 && document.getElementById('showCatHint')?.checked && showHint) {
      const tag = document.createElement('div');
      tag.className = 'hint';
      tag.textContent = it.category;
      div.appendChild(tag);
    }

    const lane  = i % 2 ? 10 : 20;
    const delay = i * 0.35;
    div.style.bottom = `${lane}px`;
    div.style.animationDelay = `${delay}s`;

    belt.appendChild(div);
  });
}
function shiftBelt(){
  const belt = document.getElementById('beltItems');
  if(!belt || !belt.firstElementChild) return;
  belt.firstElementChild.remove();
}

// ✅ Small helper to toggle the belt stripe animation (pause until game runs)
function beltRunning(on){
  const beltEl = document.querySelector('.belt');
  if (!beltEl) return;
  beltEl.classList.toggle('running', !!on);
}
// === Game state + presets
let CG = null;
const PRESETS = {
  rookie:{customers:5,  maxItems:3},
  cashier:{customers:8, maxItems:6},
  speed:{customers:12,  maxItems:8},
  expert:{customers:15, maxItems:12}
};

// === Timer helpers
let cgTimerId = null;
let cgTimerToken = 0;
function clearCgTimer(targetSel){
  if (cgTimerId !== null){ clearInterval(cgTimerId); cgTimerId = null; }
  if (targetSel){ const t = document.querySelector(targetSel); if (t) t.textContent = ""; }
}
function startTimer(sec, targetSel){
  const target = document.querySelector(targetSel);
  if (!target) return;
  clearCgTimer(targetSel);

  const myToken = ++cgTimerToken;
  const start = Date.now();

  const tick = () => {
    if (myToken !== cgTimerToken) return;
    const left = Math.max(0, sec - Math.floor((Date.now() - start)/1000));
    target.textContent = `⏱ ${left}s`;
    if (left <= 0){
      clearCgTimer(targetSel);
      target.textContent = "⏱ 0s — time!";
      if (CG){ CG.streak = 0; nextWrong(); }
    }
  };
  tick();
  cgTimerId = setInterval(tick, 200);
}
// ---------------- Difficulty & Masking ----------------
function currentDifficultyKey(){
  return ($("#cgPreset").value || "cashier"); // rookie | cashier | speed | expert
}

// How many trailing digits should be hidden for a given code length + difficulty.
// Special rule: 5-digit organics ending in '9' → rookie hides 2.
function maskCountFor(codeStr, difficulty){
  const len = codeStr.length;
  const organic5 = (len === 5 && codeStr.endsWith('9'));
  const table = {
    rookie:  organic5 ? 2 : 1,
    cashier: organic5 ? 3 : 2,
    speed:   organic5 ? 4 : 3,
    expert:  organic5 ? 5 : 4
  };
  return Math.max(1, Math.min(len, table[difficulty] || table.cashier));
}

// Turn the code into a masked hint string (e.g. "219?", "21??", "2???", "????")
function buildMaskHint(codeStr, hideCount){
  const keep = codeStr.slice(0, Math.max(0, codeStr.length - hideCount));
  return keep + '?'.repeat(hideCount);
}

// Map dropdown preset -> how many trailing digits are hidden (mask)
function presetToMask(preset){
  switch (preset) {
    case 'rookie':  return 1;
    case 'cashier': return 2;
    case 'speed':   return 3;
    case 'expert':  return 99; // bigger than any code length → full code
    default:        return 1;
  }
}
// === Start / Stop / Flow
function startCG(){
  const p = PRESETS[$("#cgPreset").value];
  const timer = parseInt($("#cgTimer").value,10)||0;

  const preset = $("#cgPreset").value;
  const expectedDigits = presetToMask(preset);

  CG = {
    cust:0, custTotal:p.customers,
    item:0, itemTotal:0,
    timer,
    streak:0,
    bestStreakRun: 0,
    difficulty: preset,
    expectedDigits,
    queue:[]
  };

  // ✅ these belong inside startCG
  $("#cgStart").disabled = true;
  $("#cgStop").disabled  = false;
  $("#cgStreak").textContent  = 0;
  $("#cgCust").textContent    = 0;
  $("#cgCustTotal").textContent = CG.custTotal;
  $("#cgFeedback").textContent = "";
  setRegDigits("");
  $("#cgInput").readOnly   = true;
  $("#cgInput").value      = "";
  $("#cgSkip").disabled    = false;

  document.getElementById('beltItems').innerHTML = '';
  setRandomAvatar();
  beltRunning(true);

  nextCustomer();
}
function nextCustomer(){
  if (!CG) return;

  CG.cust++;

  // Finished?
  if (CG.cust > CG.custTotal){
    const runBest = CG.bestStreakRun || 0;
    const diff    = CG.difficulty || $("#cgPreset").value || 'cashier';

    // submit PB to Firestore (module helper exposed on window)
    submitLeaderboardIfPB({ bestStreakRun: runBest, difficulty: diff })
      .then(updated=>{
        const base = "🏁 Done!";
        $("#cgFeedback").textContent = updated
          ? `${base} 🏆 New personal best for ${diff}: ${runBest}`
          : base;
      })
      .catch(()=>{ $("#cgFeedback").textContent = "🏁 Done!"; });

    document.getElementById('beltItems').innerHTML = '';
    const av = document.getElementById('customerAvatar');
    if (av) av.innerHTML = '<span class="muted small">Customer</span>';
    clearCgTimer("#cgFeedback");
    beltRunning(false);
    $("#cgStart").disabled = false;
    $("#cgStop").disabled  = true;

    CG = null;
    return;
  }

  // ✅ queue setup (was outside the function)
  const maxItems = PRESETS[$("#cgPreset").value].maxItems;
  const n = 1 + Math.floor(Math.random() * maxItems);

  // Prefer SRS-due if ON
  let pool;
  if ($("#srsMode")?.checked) {
    const due = srsDueItems();
    pool = due.length ? due : [...DATA];
  } else {
    pool = [...DATA];
  }

  CG.item = 0;
  CG.itemTotal = n;
  CG.queue = shuffle(pool).slice(0, n);

  $("#cgCust").textContent = CG.cust;
  $("#cgCustTotal").textContent = CG.custTotal;

  setRandomAvatar();
  renderBelt(CG.queue.slice(CG.item), true);
  nextItemCG();
}
function nextItemCG(){
  if (!CG) return;

  clearCgTimer("#cgFeedback");

  if (CG.item >= CG.itemTotal){ nextCustomer(); return; }

  const it = CG.queue[CG.item];
// Build and show the masked hint
const diff = currentDifficultyKey();
const hide = maskCountFor(it.code, diff);
const hint = buildMaskHint(it.code, hide);
$("#regMask").textContent = hint;

// Expect only the missing trailing digits to be entered
CG.expectedDigits = hide;
  // Show item preview INSIDE register
  setPreview(it);

  // counters + input
  $("#cgItem").textContent      = CG.item + 1;
  $("#cgItemTotal").textContent = CG.itemTotal;
  $("#cgInput").value = "";
  $("#cgFeedback").textContent = "";
  setRegDigits("");
  if (CG.timer > 0){ startTimer(CG.timer, "#cgFeedback"); }

  renderBelt(CG.queue.slice(CG.item), true);
}
function enterCG(){
  if (!CG) return;

  const it = CG.queue[CG.item];

  // What the user typed on the register display
  const typed = ($("#regDigits").textContent || "").replace(/[^\d]/g,"");

  // How many trailing digits are hidden (by difficulty)
  // e.g. Rookie=1, Cashier=2, Speed=3, Expert=full length
  const hide = Math.max(1, CG?.expectedDigits || 1);

  // The part we expect them to type is the last `hide` digits
  const need = it.code.slice(-hide);

  // Correct if typed matches the hidden tail
  const ok = (typed === need);

  // Feedback (use `typed`, not a non-existent `digits` var)
  $("#cgFeedback").textContent = ok
    ? `✅ ${it.code} — +1 streak!`
    : `❌ ${typed || '—'} → ${it.code}`;

  // SRS + due badge
  srsUpdate(it.code, ok);
  updateDueBadge();

  // Haptics/sound
  if (ok) giveFeedback("success"); else giveFeedback("error");

  // Stats + run streaks
  STATS.seen++;
  if (ok) {
    STATS.correct++;
    CG.streak = (CG.streak || 0) + 1;
  } else {
    CG.streak = 0;
  }
  // Session-best streak (for this run)
  CG.bestStreakRun = Math.max(CG.bestStreakRun || 0, CG.streak || 0);
  // All-time best streak (global)
  STATS.bestStreak = Math.max(STATS.bestStreak, CG.streak);

  saveStats();
  renderStats();

  // Advance belt + item
  clearCgTimer("#cgFeedback");
  shiftBelt();
  CG.item++;
  setTimeout(nextItemCG, 300);
}

function skipCG(){
  if (!CG) return;
  CG.streak = 0;
  clearCgTimer("#cgFeedback");
  shiftBelt();
  nextWrong();
}

function nextWrong(){
  if (!CG) return;
  CG.item++;
  setTimeout(nextItemCG, 200);
}

// === Controls & keypad wiring
document.getElementById('showCatHint')?.addEventListener('change', ()=>{
  if (!CG || !CG.queue) return;
  renderBelt(CG.queue.slice(CG.item), document.getElementById('showCatHint').checked);
});

$("#cgSkip").onclick  = skipCG;

// Register keypad ...
document.querySelectorAll('#regPad .kkey').forEach(k => {
  k.addEventListener('click', () => {
    const key = k.dataset.key;
    const out = document.getElementById('regDigits');
    if (!out) return;

    if (key === 'enter') { 
      enterCG(); 
      return; 
    }

    // current value (treat em dash as empty)
    const cur = out.textContent === "—" ? "" : out.textContent;

    if (key === 'back') {
      setRegDigits(cur.slice(0, -1));  // delete last char
      return;
    }

    if (key === 'clear') {
      setRegDigits("");                // clear everything
      return;
    }

    // digit (0–9): append but cap at expected length
    const maxLen = Math.max(1, CG?.expectedDigits || 5);
    setRegDigits((cur + key).slice(0, maxLen));
  });
});
// Keep belt empty / paused until Start
renderBelt([]);
beltRunning(false);
setPreview({name:'—', category:'', image:''});
  // --- Simple Start / Stop (no animations) ---
const startBtn = document.getElementById('cgStart');
const stopBtn  = document.getElementById('cgStop');

startBtn?.addEventListener('click', ()=>{
  startBtn.disabled = true;
  stopBtn.disabled  = false;
  startCG();          // start the normal checkout game
});

stopBtn?.addEventListener('click', ()=>{
  stopBtn.disabled  = true;
  startBtn.disabled = false;

  // Soft stop only belt + timer
  const belt = document.getElementById('beltItems');
  if (belt) belt.innerHTML = '';
  clearCgTimer("#cgFeedback");
  document.getElementById('cgFeedback').textContent = "⏹ Stopped.";
  beltRunning(false);
});
// --------------- SRS Badge Sync ----------------
function updateSrsBadge() {
  const isOn = !!document.getElementById("srsMode")?.checked;

  // Header badge
  const badge = document.getElementById("srsBadge");
  if (badge) {
    badge.textContent = isOn ? "ON" : "OFF";
    badge.classList.toggle("ON",  isOn);
    badge.classList.toggle("OFF", !isOn);
  }

  // Quiz badge (mirror in Quiz section)
  const qb = document.getElementById("srsBadgeQuiz");
  if (qb) qb.textContent = isOn ? "ON" : "OFF";
}
document.getElementById("srsMode")?.addEventListener("change", ()=>{
  updateSrsBadge();
  q = { i: 0, order: buildQuizOrder() };
  showQuiz();
  updateDueBadge();
});
updateSrsBadge();

// --------------- Browse / Search + Favorites ----------------
// Rebuild the list of items (called elsewhere)
function renderBrowse(){
  const norm = s => s.toLowerCase();
  const q = norm($("#searchBox").value.trim());
  const cat = $("#catFilter").value;
  const favOnly = $("#favOnly").checked;
  const list = $("#browseList");
  list.innerHTML = "";

  const results = DATA.filter(it => {
    const n = norm(it.name);
    const hit = n.includes(q) || it.code.includes(q) || n.replace(/\s+/g,'').includes(q);
    const catOk = !cat || it.category === cat;
    const favOk = !favOnly || FAV.has(it.code);
    return hit && catOk && favOk;
  });

  updateItemCount(results.length);

  results.forEach(it => {
    const row = document.createElement('div');
    row.className = 'rowline';
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <span class="star" data-code="${it.code}">${FAV.has(it.code) ? '⭐' : '☆'}</span>
        <div>
          <div><b>${it.name}</b> <span class="muted small">(${it.category})</span></div>
          <div class="small muted">${it.code}${it.notes ? ' — ' + it.notes : ''}</div>
        </div>
      </div>
      <div class="imgbox">${it.image ? `<img src="${it.image}">` : `<span class="muted small">No picture</span>`}</div>
    `;
    list.appendChild(row);
  });

  // ⭐ wire up stars AFTER rendering
  $$('.star').forEach(s => {
    s.onclick = () => {
      const c = s.dataset.code;
      if (FAV.has(c)) FAV.delete(c); else FAV.add(c);
      saveFav();
      renderBrowse(); // refresh stars/count immediately
    };
  });
}

function buildCatFilter(){
  const cats = Array.from(new Set(DATA.map(d => d.category))).sort();
  $("#catFilter").innerHTML =
    `<option value="">All Categories</option>` +
    cats.map(c => `<option>${c}</option>`).join('');
}

// search/filter wiring
$("#searchBox").oninput  = renderBrowse;
$("#catFilter").onchange = renderBrowse;
$("#favOnly").onchange   = renderBrowse;

// init
buildCatFilter();
renderBrowse();
updateItemCount();

// --------------- Stats ----------------
function renderStats(){
  const acc = accuracyPct(STATS);
  $("#stats").innerHTML = `
    <div class="row" style="align-items:flex-end; gap:12px">
      <div class="card" style="flex:1; padding:10px"><div class="muted small">Seen</div><div style="font-size:1.4rem;font-weight:700">${fmt(STATS.seen)}</div></div>
      <div class="card" style="flex:1; padding:10px"><div class="muted small">Correct</div><div style="font-size:1.4rem;font-weight:700">${fmt(STATS.correct)}</div></div>
      <div class="card" style="flex:1; padding:10px"><div class="muted small">Accuracy</div><div style="font-size:1.4rem;font-weight:700">${acc}%</div></div>
      <div class="card" style="flex:1; padding:10px"><div class="muted small">Streak</div><div style="font-size:1.4rem;font-weight:700">${fmt(STATS.streak)}</div></div>
      <div class="card" style="flex:1; padding:10px"><div class="muted small">Best</div><div style="font-size:1.4rem;font-weight:700">${fmt(STATS.bestStreak)}</div></div>
    </div>`;
}
// --- Unified helper to set register digits + placeholder style ---
function setRegDigits(v){
  const out = document.getElementById('regDigits');
  // if v is empty or undefined, show em dash
  out.textContent = (v && v.length) ? v : "—";
  // toggle the placeholder style based on the value
  out.classList.toggle('placeholder', out.textContent === "—");
}
// ---------- Export / Share ----------
function buildBackupPayload(){
  return { when: new Date().toISOString(), version: 1, data: DATA, fav: [...FAV], stats: STATS };
}
$("#exportData")?.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(buildBackupPayload(), null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'plu_trainer_backup.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});
$("#shareStats")?.addEventListener('click', async ()=>{
  const text = prettyStatsText();
  const json = JSON.stringify({ when:new Date().toISOString(), version:1, stats:STATS, accuracy: accuracyPct(STATS)+"%" }, null, 2);
  const file = new File([json], 'plu_trainer_stats.json', {type:'application/json'});
  try {
    if (navigator.canShare && navigator.canShare({ files:[file] })) {
      await navigator.share({ title:'PLU Trainer Stats', text, files:[file] }); return;
    }
  } catch(e){}
  try {
    if (navigator.share) { await navigator.share({ title:'PLU Trainer Stats', text }); return; }
  } catch(e){}
  try { await navigator.clipboard.writeText(text); alert("Stats copied to clipboard. Paste into Messages/Email."); }
  catch(e){ const blob = new Blob([text], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plu_trainer_stats.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
});

// --- First-time onboarding tip
if (!localStorage.getItem('ONBOARDED')) {
  alert('Tip: Use Browse to ⭐ favorite tricky items, then practice in Quiz or Checkout.');
  localStorage.setItem('ONBOARDED','1');
}
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
  <script type="module">
  // --- Firebase imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, 
    collection, query, where, orderBy, limit, onSnapshot 
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // --- Your config (use the one Firebase gave you) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBgNMpEr79FSuY1XHh-MNeuPTz2q8S42FE",
    authDomain: "plu-trainer-8e076.firebaseapp.com",
    projectId: "plu-trainer-8e076",
    storageBucket: "plu-trainer-8e076.firebasestorage.app",
    messagingSenderId: "206662075637",
    appId: "1:206662075637:web:f18d0a071c2ef5a072b1bc",
    measurementId: "G-DE56L82L51"
  };

  // --- Init ---
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Sign in anonymously so each device has a UID
  onAuthStateChanged(auth, (user) => { if (!user) signInAnonymously(auth); });
  // also try silently (no harm if already signed in)
  signInAnonymously(auth).catch(console.error);

    // keep track of uid
onAuthStateChanged(auth, (user) => {
  if (user) {
    console.log("Signed in as", user.uid);
    window.currentUser = user; // store globally for leaderboard writes
  }
});
  // Small helper to pick the Firestore field name by difficulty
  function fieldFor(diff){
    switch (diff) {
      case 'rookie':  return 'best_rookie';
      case 'speed':   return 'best_speed';
      case 'expert':  return 'best_expert';
      default:        return 'best_cashier';
    }
  }

  // Escape HTML (avoid bad input in names)
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ✅ Submit PB if higher than stored (called when a run finishes)
  window.submitLeaderboardIfPB = async function({ bestStreakRun, difficulty }){
    try {
      const user = auth.currentUser;
      if (!user) return false;

      const uid   = user.uid;
      const field = fieldFor(difficulty);

      // Pull the local profile for name/cashier if you have it
      let name = 'Anonymous', cashier = '';
      try {
        const p = JSON.parse(localStorage.getItem('PROFILE_V1') || '{}');
        if (p?.name) name = p.name;
        if (p?.cashier) cashier = p.cashier;
      } catch(e){}

      const ref  = doc(db, 'leaderboard', uid);
      const snap = await getDoc(ref);

      if (!snap.exists()){
        const data = {
          name, cashier,
          best_rookie: 0,
          best_cashier: 0,
          best_speed: 0,
          best_expert: 0,
          updatedAt: serverTimestamp()
        };
        data[field] = bestStreakRun;
        await setDoc(ref, data);
        return true; // first record is a PB
      } else {
        const cur = snap.data()[field] || 0;
        if (bestStreakRun > cur){
          await updateDoc(ref, {
            [field]: bestStreakRun,
            name, cashier,
            updatedAt: serverTimestamp()
          });
          return true; // updated PB
        }
        return false; // not a PB
      }
    } catch (e) {
      console.error('submitLeaderboardIfPB error', e);
      return false;
    }
  };
    // Keep leaderboard doc's name/cashier synced even when no new PB happens
window.syncLeaderboardName = async function(){
  try{
    const user = auth.currentUser;
    if (!user) return;
    const uid = user.uid;

    const name    = (window.PROFILE && window.PROFILE.name)    ? window.PROFILE.name    : 'Anonymous';
    const cashier = (window.PROFILE && window.PROFILE.cashier) ? window.PROFILE.cashier : '';

    await setDoc(doc(db, 'leaderboard', uid), {
      name, cashier,
      updatedAt: serverTimestamp()
    }, { merge: true });
  }catch(e){
    console.warn('syncLeaderboardName failed', e);
  }
};
  // ... keep the rest of your module script
  // ✅ Live leaderboard listener (auto-updates table)
  let lbUnsub = null;
  window.watchLeaderboard = function(diff){
    // clean up old listener
    if (lbUnsub) { try { lbUnsub(); } catch(e){} lbUnsub = null; }

    const tbody = document.getElementById('lbTableBody');
    if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="muted small">Loading…</td></tr>`;

    const field = fieldFor(diff);
    const qref  = query(
      collection(db, 'leaderboard'),
      where(field, '>', 0),
      orderBy(field, 'desc'),
      limit(20)
    );

    lbUnsub = onSnapshot(qref, (snap) => {
      const rows = [];
      let rank = 1;
      snap.forEach(docSnap => {
        const d = docSnap.data();
        rows.push(
          `<tr>
            <td>${rank++}</td>
            <td>${escapeHtml(d.name || 'Anonymous')}</td>
            <td>${escapeHtml(d.cashier || '')}</td>
            <td>${d[field] || 0}</td>
          </tr>`
        );
      });
      if (tbody) {
        tbody.innerHTML = rows.length
          ? rows.join('')
          : `<tr><td colspan="4" class="muted small">No scores yet.</td></tr>`;
      }
    }, (err) => {
      console.error(err);
      if (tbody) tbody.innerHTML = `<tr><td colspan="4" class="muted small">Error loading leaderboard.</td></tr>`;
    });
  };

  // Start the leaderboard watcher when the page loads and whenever difficulty changes
  window.addEventListener('load', () => {
    const sel = document.getElementById('lbDiff');
    if (!sel) return;
    window.watchLeaderboard(sel.value || 'cashier');
    sel.addEventListener('change', () => window.watchLeaderboard(sel.value || 'cashier'));
  });
</script>
</body>
</html>
